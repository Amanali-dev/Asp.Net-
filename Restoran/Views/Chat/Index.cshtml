@model List<ChatMessage>

<style>
    /* Chat-specific styles only */
    #chat-container {
        max-width: 600px;
        margin: 20px auto;
        border: 1px solid #ccc;
        border-radius: 10px;
        background: #fff;
        display: flex;
        flex-direction: column;
        height: 500px;
    }

    #messages {
        flex: 1;
        padding: 10px;
        overflow-y: auto;
        font-family: Arial, sans-serif;
    }

    .message {
        padding: 6px 10px;
        margin-bottom: 5px;
        border-radius: 8px;
        word-wrap: break-word;
    }

        .message.self {
            background: #d1ffd6;
            align-self: flex-end;
        }

        .message.other {
            background: #f0f0f0;
            align-self: flex-start;
        }

    .timestamp {
        font-size: 10px;
        color: gray;
        margin-left: 5px;
    }

    #typing {
        font-size: 12px;
        color: gray;
        padding: 5px 10px;
        height: 18px;
    }

    #input-container {
        display: flex;
        border-top: 1px solid #ddd;
        padding: 5px 10px;
        gap: 5px;
    }

        #input-container input[type="text"] {
            flex: 1;
            padding: 6px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        #input-container button {
            padding: 6px 15px;
            border-radius: 5px;
            border: none;
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
        }
</style>

<div id="chat-container">
    <div id="messages">
        @foreach (var m in Model)
        {
            var cls = m.User == "YourName" ? "self" : "other";
            <div class="message @cls">
                <strong>@m.User</strong>: @m.Message
                <span class="timestamp">(@m.Timestamp.ToString("hh:mm tt"))</span>
            </div>
        }
    </div>

    <div id="typing">Someone is typing...</div>

    <div id="input-container">
        <input type="text" id="username" placeholder="Your name" />
        <input type="text" id="message" placeholder="Type a message..." />
        <button id="sendBtn">Send</button>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
<script>
    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/chatHub")
        .build();

    connection.start();

    connection.on("ReceiveMessage", (user, message, time) => {
        const msgDiv = document.createElement("div");
        const cls = user === document.getElementById("username").value ? "self" : "other";
        msgDiv.className = "message " + cls;
        msgDiv.innerHTML = `<strong>${user}</strong>: ${message} <span class="timestamp">(${time})</span>`;
        document.getElementById("messages").appendChild(msgDiv);
        document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
    });

    connection.on("UserTyping", user => {
        const t = document.getElementById("typing");
        t.innerText = user + " is typing...";
        t.style.display = "block";
        setTimeout(() => t.style.display = "none", 2000);
    });

    document.getElementById("sendBtn").addEventListener("click", () => {
        const user = document.getElementById("username").value;
        const msg = document.getElementById("message").value;
        if(msg.trim() === "") return;
        connection.invoke("SendMessage", user, msg);
        document.getElementById("message").value = "";
    });

    document.getElementById("message").addEventListener("input", () => {
        const user = document.getElementById("username").value;
        connection.invoke("Typing", user);
    });
</script>
